<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Botswana - Central Social Work Daily Logbook</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3c72 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 1.8em; font-weight: 500; }
        .header-info { text-align: right; font-size: 0.9em; opacity: 0.9; }
        .user-info { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 5px; margin-top: 5px; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px; }
        
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; padding: 40px; }
        .login-box {
            background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-box h2 { color: #333; margin-bottom: 30px; font-size: 1.5em; }
        .login-form { display: flex; flex-direction: column; gap: 20px; }
        .login-form select, .login-form input {
            padding: 15px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;
        }
        .login-form select:focus, .login-form input:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
            padding: 15px; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); }
        
        .main-content { padding: 30px; display: none; }
        .main-content.active { display: block; }
        .date-selector {
            display: flex; gap: 15px; align-items: center; margin-bottom: 25px; padding: 15px;
            background: #f8f9fa; border-radius: 8px;
        }
        .date-selector label { font-weight: 600; color: #333; }
        .date-selector input { padding: 8px 12px; border: 2px solid #e0e6ed; border-radius: 5px; font-size: 14px; }
        
        .section-title {
            font-size: 1.4em; color: #333; margin-bottom: 25px; font-weight: 600;
            border-bottom: 3px solid #667eea; padding-bottom: 10px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #444; font-weight: 500; font-size: 0.95em; }
        .required { color: #dc3545; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px;
            transition: all 0.3s ease; font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .action-buttons {
            display: flex; gap: 15px; margin-top: 30px; padding-top: 20px;
            border-top: 2px solid #f0f0f0; flex-wrap: wrap;
        }
        .save-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
            padding: 12px 25px; border-radius: 8px; font-size: 14px; cursor: pointer;
            transition: all 0.3s ease; font-weight: 600;
        }
        .save-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); }
        .export-btn {
            background: #17a2b8; color: white; border: none; padding: 12px 25px; border-radius: 8px;
            font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        .export-btn:hover { background: #138496; transform: translateY(-2px); }
        .clear-btn {
            background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 8px;
            font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        
        .status-indicator { padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-ready { background: #d1ecf1; color: #0c5460; }
        .status-saving { background: #fff3cd; color: #856404; }
        .status-saved { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .stats-card {
            background: #f8f9fa; padding: 25px; border-radius: 10px; border-left: 4px solid #667eea; text-align: center;
        }
        .stats-number { font-size: 2.5em; font-weight: 700; color: #667eea; margin-bottom: 5px; }
        .stats-label { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        
        .daily-entries {
            background: white; border: 1px solid #e0e6ed; border-radius: 8px; overflow: hidden;
            max-height: 500px; overflow-y: auto;
        }
        .entry-item {
            padding: 15px 20px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.3s ease;
        }
        .entry-item:hover { background: #f8f9fa; }
        .entry-item:last-child { border-bottom: none; }
        .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .entry-user { font-weight: 600; color: #333; }
        .entry-activity {
            background: #e8f4f8; color: #0c5460; padding: 2px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600; text-transform: uppercase;
        }
        .entry-summary { color: #666; font-size: 13px; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .entry-meta { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #888; }
        .entry-time { margin-right: 15px; }
        .entry-people { color: #667eea; font-weight: 600; }
        .view-btn {
            background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px;
            cursor: pointer; font-size: 11px; margin-left: 10px;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="https://lovebotswana.org/wp-content/uploads/2021/06/cropped-Love-Botswana-Logo-300x300.png" 
                     alt="Love Botswana Logo" 
                     style="height: 50px; width: 50px; border-radius: 8px; background: white; padding: 5px;"
                     onerror="this.style.display='none'">
                <div><h1>Love Botswana - Central Daily Logbook</h1></div>
            </div>
            <div class="header-info">
                <div id="currentDate"></div>
                <div>Social Work Department</div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="currentUser"></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <!-- Login Screen -->
        <div class="login-container" id="loginScreen">
            <div class="login-box">
                <h2>Login to Daily Logbook</h2>
                <form class="login-form" onsubmit="login(event)">
                    <select id="userRole" required>
                        <option value="">Select Department Activity</option>
                        <option value="operation-blessing">Operation Blessing</option>
                        <option value="counseling-session">Counseling Session</option>
                        <option value="play-therapy">Play Therapy</option>
                        <option value="meeting">Meeting</option>
                        <option value="case">Case</option>
                        <option value="donations">Donations</option>
                        <option value="intake-session">Intake Session</option>
                        <option value="workshop">Workshop</option>
                        <option value="other-activities">Other Activities</option>
                        <option value="admin">Administrator/Supervisor</option>
                    </select>
                    <input type="text" id="userName" placeholder="Enter your full name" required>
                    <button type="submit" class="login-btn">Login & Start Daily Log</button>
                </form>
                <div style="margin-top: 20px; font-size: 12px; color: #666; text-align: center;">
                    <p><strong>Instructions:</strong></p>
                    <p>Social Workers: Log daily activities - saved permanently to Google Sheets</p>
                    <p>Administrators: View all team entries and generate reports</p>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="main-content" id="dashboard">
            <div class="date-selector">
                <label for="logDate">Log Date:</label>
                <input type="date" id="logDate">
                <button class="save-btn" style="padding: 8px 15px; font-size: 13px;" onclick="loadDateData()">Load Date</button>
                <div style="margin-left: auto;">
                    <span class="status-indicator status-ready" id="saveStatus">Ready to Log</span>
                </div>
            </div>

            <!-- Staff Daily Log Entry View -->
            <div id="staffView" style="display: none;">
                <h2 class="section-title" id="staffTitle">Daily Activity Log Entry</h2>
                
                <div class="form-group">
                    <label for="staffActivities">Today's Activities & Description <span class="required">*</span></label>
                    <textarea id="staffActivities" placeholder="Describe the specific activities, services provided, or work completed today..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="staffOutcomes">Key Outcomes & Results <span class="required">*</span></label>
                    <textarea id="staffOutcomes" placeholder="What were the main outcomes, results, or positive impacts from today's activities..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="staffPeopleServed">People Served/Contacted</label>
                        <input type="number" id="staffPeopleServed" placeholder="Number of people" min="0">
                    </div>
                    <div class="form-group">
                        <label for="staffDuration">Time Spent (minutes)</label>
                        <input type="number" id="staffDuration" placeholder="Duration in minutes" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="staffChallenges">Challenges or Issues Encountered</label>
                    <textarea id="staffChallenges" placeholder="Describe any challenges, obstacles, or issues you encountered today..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="staffNotes">Additional Notes & Observations</label>
                    <textarea id="staffNotes" placeholder="Additional notes, observations, follow-up needed, or other relevant information..."></textarea>
                </div>

                <div class="form-group">
                    <label for="staffFollowUp">Follow-up Actions Required</label>
                    <textarea id="staffFollowUp" placeholder="What follow-up actions or next steps are needed based on today's activities?"></textarea>
                </div>

                <div class="action-buttons">
                    <button class="save-btn" onclick="saveToGoogleSheets()">Save to Google Sheets</button>
                    <button class="export-btn" onclick="viewMyPastLogs()">View My Past Logs</button>
                    <button class="export-btn" onclick="exportMyDailyLog()">Export My Log</button>
                    <button class="clear-btn" onclick="clearStaffForm()">Clear Form</button>
                </div>
            </div>

            <!-- My Past Logs View -->
            <div id="pastLogsView" style="display: none;">
                <h2 class="section-title" id="pastLogsTitle">My Past Daily Logs</h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                    <button class="save-btn" onclick="loadMyPastLogs()">Refresh My Logs</button>
                    <button class="export-btn" onclick="backToStaffView()">Back to Daily Log</button>
                    <span>Showing last 10 entries</span>
                </div>

                <div class="daily-entries" id="myPastLogsList">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Click "Refresh My Logs" to load your past entries
                    </div>
                </div>
            </div>

            <!-- Administrator Central Dashboard View -->
            <div id="adminView" style="display: none;">
                <div class="dashboard-grid">
                    <div class="stats-card">
                        <div class="stats-number" id="totalEntries">0</div>
                        <div class="stats-label">Daily Entries</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalPeopleServed">0</div>
                        <div class="stats-label">People Served Today</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="activeStaff">0</div>
                        <div class="stats-label">Active Staff</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalHours">0.0</div>
                        <div class="stats-label">Total Hours</div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                    <button class="export-btn" onclick="loadFromGoogleSheets()">Refresh from Google Sheets</button>
                    <button class="save-btn" onclick="exportDailySummary()">Export Daily Summary</button>
                    <button class="export-btn" onclick="openGoogleSheets()">Open Google Sheets</button>
                </div>

                <h3 class="section-title">Today's Central Log Entries</h3>
                <div class="daily-entries" id="centralLogEntries">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Click "Refresh from Google Sheets" to load today's entries
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userRole = null;
        let currentDate = '';
        let sheetsId = '1r93GO6gRXHvLs0bqiPz5WtH5fsLhTzsZrRMBb20n4ZM';
        let centralLogEntries = [];

        function init() {
            updateCurrentDate();
            setDefaultDate();
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            currentDate = today;
            document.getElementById('logDate').value = today;
        }

        function login(event) {
            event.preventDefault();
            userRole = document.getElementById('userRole').value;
            currentUser = document.getElementById('userName').value.trim();
            
            if (!userRole || !currentUser) {
                alert('Please select your activity and enter your name.');
                return;
            }

            document.getElementById('currentUser').textContent = `${currentUser} (${getRoleDisplayName(userRole)})`;
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            if (userRole === 'admin') {
                showAdminView();
            } else {
                showStaffView();
            }
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'Administrator/Supervisor', 'operation-blessing': 'Operation Blessing',
                'counseling-session': 'Counseling Session', 'play-therapy': 'Play Therapy',
                'meeting': 'Meeting', 'case': 'Case', 'donations': 'Donations',
                'intake-session': 'Intake Session', 'workshop': 'Workshop', 'other-activities': 'Other Activities'
            };
            return roleNames[role] || role;
        }

        function showStaffView() {
            document.getElementById('staffView').style.display = 'block';
            document.getElementById('adminView').style.display = 'none';
            document.getElementById('pastLogsView').style.display = 'none';
            document.getElementById('staffTitle').textContent = `${getRoleDisplayName(userRole)} - Daily Log Entry`;
        }

        function showAdminView() {
            document.getElementById('staffView').style.display = 'none';
            document.getElementById('adminView').style.display = 'block';
            document.getElementById('pastLogsView').style.display = 'none';
            loadFromGoogleSheets();
        }

        function viewMyPastLogs() {
            document.getElementById('staffView').style.display = 'none';
            document.getElementById('adminView').style.display = 'none';
            document.getElementById('pastLogsView').style.display = 'block';
            document.getElementById('pastLogsTitle').textContent = `${currentUser} - Past Daily Logs`;
            loadMyPastLogs();
        }

        function backToStaffView() {
            showStaffView();
        }

        function loadDateData() {
            currentDate = document.getElementById('logDate').value;
            if (userRole === 'admin') {
                loadFromGoogleSheets();
            }
        }

        async function saveToGoogleSheets() {
            if (!document.getElementById('staffActivities').value.trim() || !document.getElementById('staffOutcomes').value.trim()) {
                alert('Please fill in all required fields (Activities and Outcomes).');
                return;
            }

            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = 'Saving...';
            saveStatus.className = 'status-indicator status-saving';

            const formData = new FormData();
            formData.append('date', currentDate);
            formData.append('time', new Date().toLocaleTimeString());
            formData.append('staffName', currentUser);
            formData.append('activityType', getRoleDisplayName(userRole));
            formData.append('activities', document.getElementById('staffActivities').value.trim());
            formData.append('outcomes', document.getElementById('staffOutcomes').value.trim());
            formData.append('peopleServed', document.getElementById('staffPeopleServed').value || '0');
            formData.append('duration', document.getElementById('staffDuration').value || '0');
            formData.append('challenges', document.getElementById('staffChallenges').value.trim());
            formData.append('notes', document.getElementById('staffNotes').value.trim());
            formData.append('followUp', document.getElementById('staffFollowUp').value.trim());

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbw0gOA70MBHSpIhjCDdiGiy4UphAQ6uKQVdw2QFvVMTvHeWhaIAtq1l0LvQEtn5GuK5/exec', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.data) {
                    centralLogEntries = result.data;
                    updateDashboardStats(result.data);
                    displayCentralEntries(result.data);
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('Load error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Unable to load data automatically from Google Sheets.</p>
                        <p><strong>Alternative:</strong> <a href="https://docs.google.com/spreadsheets/d/${sheetsId}/edit" target="_blank">Click here to view all entries directly in Google Sheets</a></p>
                        <p>You can filter by date: ${currentDate}</p>
                    </div>
                `;
                updateDashboardStats([]);
            }
        }

        function updateDashboardStats(entries) {
            document.getElementById('totalEntries').textContent = entries.length;
            const totalPeople = entries.reduce((sum, entry) => sum + (entry.peopleServed || 0), 0);
            document.getElementById('totalPeopleServed').textContent = totalPeople;
            const uniqueStaff = new Set(entries.map(entry => entry.staff)).size;
            document.getElementById('activeStaff').textContent = uniqueStaff;
            const totalMinutes = entries.reduce((sum, entry) => sum + (entry.duration || 0), 0);
            document.getElementById('totalHours').textContent = (totalMinutes / 60).toFixed(1);
        }

        function displayCentralEntries(entries) {
            const container = document.getElementById('centralLogEntries');
            
            if (!entries || entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No entries found for this date</div>';
                return;
            }

            container.innerHTML = entries.map(entry => `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-user">${entry.staff}</div>
                        <div class="entry-activity">${entry.activity}</div>
                    </div>
                    <div class="entry-summary">${entry.activities.substring(0, 100)}${entry.activities.length > 100 ? '...' : ''}</div>
                    <div class="entry-meta">
                        <span class="entry-time">${entry.time}</span>
                        <span class="entry-people">${entry.peopleServed || 0} people served</span>
                        <span>${entry.duration || 0}min</span>
                    </div>
                </div>
            `).join('');
        }

        function openGoogleSheets() {
            window.open(`https://docs.google.com/spreadsheets/d/${sheetsId}/edit`, '_blank');
        }

        function exportMyDailyLog() {
            const currentData = {
                activity: getRoleDisplayName(userRole), staffName: currentUser, date: currentDate,
                activities: document.getElementById('staffActivities').value || 'No activities specified',
                outcomes: document.getElementById('staffOutcomes').value || 'No outcomes specified',
                peopleServed: document.getElementById('staffPeopleServed').value || 'Not specified',
                duration: document.getElementById('staffDuration').value || 'Not specified',
                challenges: document.getElementById('staffChallenges').value || 'No challenges reported',
                notes: document.getElementById('staffNotes').value || 'No additional notes',
                followUp: document.getElementById('staffFollowUp').value || 'No follow-up actions specified'
            };

            const htmlContent = createDailyLogHTML(currentData);
            downloadFile(htmlContent, `Daily_Log_${currentData.staffName.replace(/\s+/g, '_')}_${currentData.activity.replace(/\s+/g, '_')}_${currentDate}.html`);
            alert('Your daily log has been exported successfully!');
        }

        function createDailyLogHTML(data) {
            return `<html><head><style>body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; color: #333; } .header { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; } .field { margin-bottom: 20px; } .field-label { font-weight: bold; color: #667eea; margin-bottom: 8px; display: block; } .field-value { padding: 12px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #667eea; white-space: pre-wrap; }</style></head><body><div class="header"><img src="https://lovebotswana.org/wp-content/uploads/2021/06/cropped-Love-Botswana-Logo-300x300.png" alt="Love Botswana Logo" style="height: 60px; margin-bottom: 15px;" onerror="this.style.display='none'"><h1>Love Botswana - Daily Activity Log</h1><p><strong>Activity:</strong> ${data.activity} | <strong>Staff:</strong> ${data.staffName} | <strong>Date:</strong> ${new Date(data.date).toLocaleDateString()}</p></div><div class="field"><div class="field-label">Today's Activities</div><div class="field-value">${data.activities}</div></div><div class="field"><div class="field-label">Key Outcomes</div><div class="field-value">${data.outcomes}</div></div><div class="field"><div class="field-label">People Served: ${data.peopleServed} | Duration: ${data.duration} minutes</div></div><div class="field"><div class="field-label">Challenges</div><div class="field-value">${data.challenges}</div></div><div class="field"><div class="field-label">Notes</div><div class="field-value">${data.notes}</div></div><div class="field"><div class="field-label">Follow-up Actions</div><div class="field-value">${data.followUp}</div></div><div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc;"><p><em>Exported on ${new Date().toLocaleString()}</em></p></div></body></html>`;
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearStaffForm() {
            if (confirm('Are you sure you want to clear all your log data? This will delete any unsaved changes.')) {
                document.querySelectorAll('#staffView input, #staffView textarea').forEach(field => {
                    field.value = '';
                });
                document.getElementById('saveStatus').textContent = 'Ready to Log';
                document.getElementById('saveStatus').className = 'status-indicator status-ready';
            }
        }

        function exportDailySummary() {
            if (!centralLogEntries || centralLogEntries.length === 0) {
                alert('No entries to export. Please refresh data first.');
                return;
            }

            const summaryData = {
                date: currentDate,
                totalEntries: centralLogEntries.length,
                totalPeople: centralLogEntries.reduce((sum, entry) => sum + (entry.peopleServed || 0), 0),
                totalHours: (centralLogEntries.reduce((sum, entry) => sum + (entry.duration || 0), 0) / 60).toFixed(1),
                activeStaff: new Set(centralLogEntries.map(entry => entry.staff)).size,
                entries: centralLogEntries
            };

            const htmlContent = createSummaryHTML(summaryData);
            downloadFile(htmlContent, `Daily_Summary_${currentDate}.html`);
            alert('Daily summary has been exported successfully!');
        }

        function createSummaryHTML(data) {
            const entriesHTML = data.entries.map(entry => `
                <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <h4>${entry.staff} - ${entry.activity}</h4>
                    <p><strong>Time:</strong> ${entry.time} | <strong>People Served:</strong> ${entry.peopleServed || 0} | <strong>Duration:</strong> ${entry.duration || 0} minutes</p>
                    <p><strong>Activities:</strong> ${entry.activities}</p>
                    <p><strong>Outcomes:</strong> ${entry.outcomes}</p>
                    ${entry.challenges ? `<p><strong>Challenges:</strong> ${entry.challenges}</p>` : ''}
                    ${entry.notes ? `<p><strong>Notes:</strong> ${entry.notes}</p>` : ''}
                    ${entry.followUp ? `<p><strong>Follow-up:</strong> ${entry.followUp}</p>` : ''}
                </div>
            `).join('');

            return `<html><head><style>body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; color: #333; } .header { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; } .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; } .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #667eea; } .stat-number { font-size: 2em; font-weight: bold; color: #667eea; } h4 { color: #667eea; margin-bottom: 10px; }</style></head><body><div class="header"><img src="https://lovebotswana.org/wp-content/uploads/2021/06/cropped-Love-Botswana-Logo-300x300.png" alt="Love Botswana Logo" style="height: 60px; margin-bottom: 15px;" onerror="this.style.display='none'"><h1>Love Botswana - Daily Summary Report</h1><p><strong>Date:</strong> ${new Date(data.date).toLocaleDateString()}</p></div><div class="stats"><div class="stat-card"><div class="stat-number">${data.totalEntries}</div><div>Total Entries</div></div><div class="stat-card"><div class="stat-number">${data.totalPeople}</div><div>People Served</div></div><div class="stat-card"><div class="stat-number">${data.activeStaff}</div><div>Active Staff</div></div><div class="stat-card"><div class="stat-number">${data.totalHours}</div><div>Total Hours</div></div></div><h2>Daily Entries</h2>${entriesHTML}<div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc;"><p><em>Report generated on ${new Date().toLocaleString()}</em></p></div></body></html>`;
        }

        function logout() {
            if (confirm('Are you sure you want to logout? Any unsaved changes will be lost.')) {
                currentUser = null;
                userRole = null;
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('userRole').value = '';
                document.getElementById('userName').value = '';
                document.getElementById('staffView').style.display = 'none';
                document.getElementById('adminView').style.display = 'none';
                document.getElementById('pastLogsView').style.display = 'none';
                
                // Reset form data
                document.querySelectorAll('#staffView input, #staffView textarea').forEach(field => {
                    field.value = '';
                });
                document.getElementById('saveStatus').textContent = 'Ready to Log';
                document.getElementById('saveStatus').className = 'status-indicator status-ready';
            }
        }

        // Initialize the application
        init();
    </script>
</body>
</html>TvHeWhaIAtq1l0LvQEtn5GuK5/exec', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    saveStatus.textContent = 'Saved to Google Sheets';
                    saveStatus.className = 'status-indicator status-saved';
                    alert('Your daily log has been saved to Google Sheets successfully!');
                } else {
                    throw new Error(result.error || 'Save failed');
                }
            } catch (error) {
                console.error('Save error:', error);
                saveStatus.textContent = 'Auto-save failed - Manual copy required';
                saveStatus.className = 'status-indicator status-error';
                
                const rowData = [currentDate, new Date().toLocaleTimeString(), currentUser, getRoleDisplayName(userRole),
                    document.getElementById('staffActivities').value.trim(), document.getElementById('staffOutcomes').value.trim(),
                    document.getElementById('staffPeopleServed').value || '0', document.getElementById('staffDuration').value || '0',
                    document.getElementById('staffChallenges').value.trim(), document.getElementById('staffNotes').value.trim(),
                    document.getElementById('staffFollowUp').value.trim()];
                
                const manualEntry = rowData.join('\t');
                if (confirm(`Unable to auto-save. Copy this data to your clipboard?\n\n${manualEntry}`)) {
                    navigator.clipboard.writeText(manualEntry).then(() => {
                        alert('Data copied to clipboard. Paste it into your Google Sheet.');
                    }).catch(() => {
                        alert('Please manually copy this data to your Google Sheet:\n\n' + manualEntry);
                    });
                }
            }
        }

        async function loadMyPastLogs() {
            const container = document.getElementById('myPastLogsList');
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading your past entries...</div>';

            try {
                const formData = new FormData();
                formData.append('action', 'getMyLogs');
                formData.append('staffName', currentUser);
                formData.append('activityType', getRoleDisplayName(userRole));

                console.log('Searching for:', currentUser, '|', getRoleDisplayName(userRole));

                const response = await fetch('https://script.google.com/macros/s/AKfycbw0gOA70MBHSpIhjCDdiGiy4UphAQ6uKQVdw2QFvVMTvHeWhaIAtq1l0LvQEtn5GuK5/exec', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Script response:', result);

                if (result.success && result.data) {
                    window.myPastLogs = result.data;
                    displayMyPastLogs(result.data);
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('Load error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Unable to load past logs automatically.</p>
                        <p><strong>Debug Info:</strong> Searching for user "${currentUser}"</p>
                        <p><strong>Alternative:</strong> <a href="https://docs.google.com/spreadsheets/d/${sheetsId}/edit" target="_blank">Click here to view your entries directly in Google Sheets</a></p>
                        <p>Filter by your name: ${currentUser}</p>
                    </div>
                `;
            }
        }

        function displayMyPastLogs(logs) {
            const container = document.getElementById('myPastLogsList');
            console.log('Displaying logs:', logs);
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>No past entries found for your account.</p>
                        <p><strong>Searched for:</strong> "${currentUser}"</p>
                        <p><strong>Try the exact name from Google Sheets.</strong></p>
                        <p><a href="https://docs.google.com/spreadsheets/d/${sheetsId}/edit" target="_blank">Click here to check the exact name in Google Sheets</a></p>
                    </div>
                `;
                return;
            }

            container.innerHTML = logs.map((log, index) => `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-user">${log.date}</div>
                        <div class="entry-activity">${log.activityType}</div>
                    </div>
                    <div class="entry-summary">${(log.activities || '').substring(0, 100)}${(log.activities || '').length > 100 ? '...' : ''}</div>
                    <div class="entry-meta">
                        <span class="entry-time">${log.time}</span>
                        <span class="entry-people">${log.peopleServed || 0} people served</span>
                        <span>${log.duration || 0}min</span>
                        <button class="view-btn" onclick="viewMyLogDetails(${index})">View Full</button>
                    </div>
                </div>
            `).join('');
        }

        function viewMyLogDetails(index) {
            const logs = window.myPastLogs || [];
            const log = logs[index];
            
            if (log) {
                alert(`Date: ${log.date} at ${log.time}\nActivity: ${log.activityType}\n\nActivities: ${log.activities || 'No activities'}\nOutcomes: ${log.outcomes || 'No outcomes'}\nPeople Served: ${log.peopleServed || 'Not specified'}\nDuration: ${log.duration || 'Not specified'} minutes\nChallenges: ${log.challenges || 'No challenges'}\nNotes: ${log.notes || 'No notes'}\nFollow-up: ${log.followUp || 'No follow-up'}`);
            }
        }

        async function loadFromGoogleSheets() {
            const container = document.getElementById('centralLogEntries');
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading today\'s entries...</div>';

            try {
                const formData = new FormData();
                formData.append('action', 'getTodaysEntries');
                formData.append('date', currentDate);

                const response = await fetch('https://script.google.com/macros/s/AKfycbw0gOA70MBHSpIhjCDdiGiy4UphAQ6uKQVdw2QFvVM